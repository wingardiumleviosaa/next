<!doctype html><html lang=en data-theme=dark><head><meta charset=utf-8><meta name=viewport content="width=device-width"><meta name=theme-color content="#222" media="(prefers-color-scheme: dark)"><meta name=generator content="Hugo 0.112.3"><link rel="shortcut icon" type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/x-icon href=/imgs/icons/favicon.ico><link rel=icon type=image/png sizes=16x16 href=/imgs/icons/favicon_16x16.png><link rel=icon type=image/png sizes=32x32 href=/imgs/icons/favicon_32x32.png><link rel=apple-touch-icon sizes=180x180 href=/imgs/icons/apple_touch_icon.png><meta itemprop=name content="[Java] JVM 架構"><meta itemprop=description content="♾️ Everyone Is An Alien Somewhere"><meta itemprop=datePublished zgotmplz><meta itemprop=dateModified zgotmplz><meta itemprop=image content="https://ulagraphy.netlify.com/imgs/riley.png"><meta itemprop=keywords content="Java"><meta property="og:type" content="article"><meta property="og:title" content="[Java] JVM 架構"><meta property="og:description" content="♾️ Everyone Is An Alien Somewhere"><meta property="og:image" content="/imgs/riley.png"><meta property="og:image:width" content="312"><meta property="og:image:height" content="312"><meta property="og:image:type" content="image/jpeg/png/svg/jpg"><meta property="og:url" content="https://ulagraphy.netlify.com/post/programming-java-jvm/java-jvm-structure/"><meta property="og:site_name" content="UlaGraphy"><meta property="og:locale" content="en"><meta property="article:author" content="Ula Hsieh"><meta property="article:published_time" content="2020-07-01 16:41:00 +0000 UTC"><meta property="article:modified_time" content="2020-07-01 16:41:00 +0000 UTC"><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/font-awesome/6.1.2/css/all.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/animate.css/3.1.1/animate.min.css><link type=text/css rel=stylesheet href=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.css><link rel=stylesheet href=/css/main.min.59da712cfdcceff10e0d33fef76aa6667f7daed10d7691d3d187f5b7782b3f5e.css><style type=text/css>.post-footer,.flinks-list-footer hr:after{content:"~ 我可是有底线的哟 ~"}</style><script type=text/javascript>(function(){localDB={set:function(e,t,n){if(n===0)return;const s=new Date,o=n*864e5,i={value:t,expiry:s.getTime()+o};localStorage.setItem(e,JSON.stringify(i))},get:function(e){const t=localStorage.getItem(e);if(!t)return void 0;const n=JSON.parse(t),s=new Date;return s.getTime()>n.expiry?(localStorage.removeItem(e),void 0):n.value}},theme={active:function(){const e=localDB.get("theme");if(e==null)return;theme.toggle(e),window.matchMedia("(prefers-color-scheme: dark)").addListener(function(e){theme.toggle(e.matches?"dark":"light")})},toggle:function(e){document.documentElement.setAttribute("data-theme",e),localDB.set("theme",e,2);const t=document.querySelector("iframe.giscus-frame");if(t){const n={setConfig:{theme:e}};t.contentWindow.postMessage({giscus:n},"https://giscus.app")}}},theme.active()})(window)</script><script class=next-config data-name=page type=application/json>{"comments":false,"isHome":false,"isPage":true,"path":"java-jvm-structure","permalink":"https://ulagraphy.netlify.com/post/programming-java-jvm/java-jvm-structure/","title":"[Java] JVM 架構","waline":{"js":[{"alias":"waline","alias_name":"@waline/client","file":"dist/pageview.js","name":"pageview","version":"2.13.0"},{"alias":"waline","alias_name":"@waline/client","file":"dist/comment.js","name":"comment","version":"2.13.0"}]}}</script><script type=text/javascript>document.addEventListener("DOMContentLoaded",()=>{var e=document.createElement("script");e.charset="UTF-8",e.src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js",e.async=!1,e.defer=!0,document.head.appendChild(e),e.onload=function(){NexT.utils.fmtBusuanzi()}})</script><title>[Java] JVM 架構 - UlaGraphy</title><noscript><link rel=stylesheet href=/css/noscript.css></noscript></head><body itemscope itemtype=http://schema.org/WebPage class=use-motion><div class=headband></div><main class=main><header class=header itemscope itemtype=http://schema.org/WPHeader><div class=header-inner><div class=site-brand-container><div class=site-nav-toggle><div class=toggle aria-label role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div></div><div class=site-meta><a href=/ class=brand rel=start><i class=logo-line></i><h1 class=site-title>UlaGraphy</h1><i class=logo-line></i></a><p class=site-subtitle itemprop=description>OOM.</p></div><div class=site-nav-right><div class="toggle popup-trigger"><i class="fa fa-search fa-fw fa-lg"></i></div></div></div><nav class=site-nav><ul class="main-menu menu"><li class="menu-item menu-item-home"><a href=/ class=hvr-icon-pulse rel=section><i class="fa fa-home hvr-icon"></i>Home</a></li><li class="menu-item menu-item-about"><a href=/about.html class=hvr-icon-pulse rel=section><i class="fa fa-user hvr-icon"></i>About</a></li><li class="menu-item menu-item-archives"><a href=/archives/ class=hvr-icon-pulse rel=section><i class="fa fa-archive hvr-icon"></i>Archives
<span class=badge>191</span></a></li><li class="menu-item menu-item-search"><a role=button class="popup-trigger hvr-icon-pulse"><i class="fa fa-search fa-fw hvr-icon"></i>Search</a></li></ul></nav><div class=search-pop-overlay><div class="popup search-popup"><div class=search-header><span class=search-icon><i class="fa fa-search"></i></span><div class=search-input-container></div><span class=popup-btn-close role=button><i class="fa fa-times-circle"></i></span></div><div class=search-result-container><div class=algolia-hits></div></div><div class=search-footer><div class=algolia-pagination></div><div class=search-meta-info><div class="search-hit-stats algolia-stats"></div><div class=search-vendor><span>Search By</span>
<a title=Algolia target=_blank href="https://www.algolia.com/?utm_source=instantsearch.js&utm_medium=website&utm_content=ulagraphy.netlify.com&utm_campaign=poweredby"><img src=/imgs/algolia-logo.svg></a></div></div></div></div></div></div><div class="toggle sidebar-toggle" role=button><span class=toggle-line></span>
<span class=toggle-line></span>
<span class=toggle-line></span></div><aside class=sidebar><div class="sidebar-inner sidebar-nav-active sidebar-toc-active"><ul class=sidebar-nav><li class=sidebar-nav-toc>TOC</li><li class=sidebar-nav-overview>Overview</li></ul><div class=sidebar-panel-container><div class="post-toc-wrap sidebar-panel"><div class="post-toc animated"><nav id=TableOfContents><ul><li><a href=#jvm-structure>JVM Structure</a><ul><li><a href=#class-loader>Class Loader</a></li><li><a href=#execution-engine>Execution Engine</a></li><li><a href=#runtime-data-areas>Runtime Data Areas</a><ul><li><a href=#pc-register>PC Register</a></li><li><a href=#jvm-stack>JVM Stack</a><ul><li><a href=#局部變量表-local-variable-array>局部變量表 (Local Variable Array)</a></li><li><a href=#運算元棧-operand-stack>運算元棧 (Operand Stack)</a></li><li><a href=#動態連接-dynamic-linking>動態連接 (Dynamic Linking)</a></li></ul></li><li><a href=#native-method-stack>Native Method Stack</a></li><li><a href=#heap>Heap</a><ul><li><a href=#堆記憶體分配>堆記憶體分配</a></li><li><a href=#garbage-collection>Garbage Collection</a></li><li><a href=#heap-大小對-gc-的影響>heap 大小對 GC 的影響</a></li></ul></li><li><a href=#metaspace-java8-以前以後>MetaSpace (Java8 以前以後)</a></li></ul></li></ul></li><li><a href=#reference>Reference</a></li></ul></nav></div></div><div class="site-overview-wrap sidebar-panel"><div class="site-author site-overview-item animated" itemprop=author itemscope itemtype=http://schema.org/Person><img class=site-author-image itemprop=image alt="Ula Hsieh" src=/imgs/img-lazy-loading.gif data-src=/imgs/riley.png><p class=site-author-name itemprop=name>Ula Hsieh</p><div class=site-description itemprop=description>♾️ Everyone Is An Alien Somewhere</div></div><div class="site-state-wrap site-overview-item animated"><nav class=site-state><div class="site-state-item site-state-posts"><a href=/archives/><span class=site-state-item-count>191</span>
<span class=site-state-item-name>Posts</span></a></div><div class="site-state-item site-state-categories"><a href=/categories/><span class=site-state-item-count>28</span>
<span class=site-state-item-name>Categories</span></a></div><div class="site-state-item site-state-tags"><a href=/tags/><span class=site-state-item-count>52</span>
<span class=site-state-item-name>Tags</span></a></div></nav></div><div class="links-of-social site-overview-item animated"><span class=links-of-social-item><a href=https://github.com/wingardiumleviosaa title="Github → https://github.com/wingardiumleviosaa" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-github fa-fw hvr-icon"></i></a></span>
<span class=links-of-social-item><a href=https://www.linkedin.com/in/ulah/ title="LinkedIn → https://www.linkedin.com/in/ulah/" rel=noopener class=hvr-icon-pulse target=_blank><i class="fab fa-linkedin fa-fw hvr-icon"></i></a></span>
<span class=links-of-social-item><a href=/ulahsieh-cv.pdf title="Reseme → /ulahsieh-cv.pdf" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-id-card fa-fw hvr-icon"></i></a></span>
<span class=links-of-social-item><a href=mailto:yiju.117@gmail.com title="Mail → mailto:yiju.117@gmail.com" rel=noopener class=hvr-icon-pulse target=_blank><i class="fa fa-envelope fa-fw hvr-icon"></i></a></span></div></div></div></div></aside><div class=sidebar-dimmer></div></header><div class=tool-buttons><div id=toggle-theme class=button title="Change Theme"><i class="fas fa-adjust"></i></div><div class=back-to-top role=button title="Back to Top"><i class="fa fa-arrow-up"></i>
<span>0%</span></div></div><div class=reading-progress-bar></div><script type=text/javascript src=//sidecar.gitter.im/dist/sidecar.v1.js async></script>
<script type=text/javascript>((window.gitter={}).chat={}).options={room:"hugo-next/community"}</script><noscript><div class=noscript-warning>Theme NexT works best with JavaScript enabled</div></noscript><div class="main-inner post posts-expand"><div class=post-block><article itemscope itemtype=http://schema.org/Article class=post-content lang><link itemprop=mainEntityOfPage href=https://ulagraphy.netlify.com/post/programming-java-jvm/java-jvm-structure/><span hidden itemprop=author itemscope itemtype=http://schema.org/Person><meta itemprop=image content="/imgs/riley.png"><meta itemprop=name content="Ula Hsieh"></span><span hidden itemprop=publisher itemscope itemtype=http://schema.org/Organization><meta itemprop=name content="Ula Hsieh"><meta itemprop=description content="♾️ Everyone Is An Alien Somewhere"></span><span hidden itemprop=post itemscope itemtype=http://schema.org/CreativeWork><meta itemprop=name content="[Java] JVM 架構"><meta itemprop=description content="前一篇介紹到 Java 程式經過編譯後會產生 .class 檔 (bytecode)，只能運行在 JVM 上，而 JVM 在運算時，如同電腦需要記憶體儲存運算所需的各種資料及指令，這篇文章將紀錄 JVM 的架構。"></span><header class=post-header><h1 class=post-title itemprop="name headline">[Java] JVM 架構</h1><div class=post-meta-container><div class=post-meta-items><span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-calendar"></i></span>
<span class=post-meta-item-text title="Publish on">Publish on:</span>
<time title="Create Time:2020-07-01 16:41:00 +0000 UTC" itemprop="dateCreated datePublished" datetime="2020-07-01 16:41:00 +0000 UTC">2020-07-01</time></span>
<span class=post-meta-item><span class=post-meta-item-icon><i class="far fa-folder-open"></i></span>
<span class=post-meta-item-text title="Classify at">Classify at:</span>
<span itemprop=about itemscope itemtype=http://schema.org/Thing><a href=/categories/java itemprop=url rel=index><span itemprop=name>Programming/Java</span></a></span></span></div><div class=post-meta-items><span class=post-meta-item title=Words><span class=post-meta-item-icon><i class="far fa-file-word"></i></span>
<span class=post-meta-item-text>Words:</span>
<span>2265</span></span>
<span class=post-meta-item title=Read><span class=post-meta-item-icon><i class="far fa-clock"></i></span>
<span class=post-meta-item-text>Read:&ap;</span>
<span>5mins</span></span></div></div></header><div class=post-body itemprop=articleBody><p>前一篇介紹到 Java 程式經過編譯後會產生 .class 檔 (bytecode)，只能運行在 JVM 上，而 JVM 在運算時，如同電腦需要記憶體儲存運算所需的各種資料及指令，這篇文章將紀錄 JVM 的架構。</p><h2 id=jvm-structure>JVM Structure
<a class=header-anchor href=#jvm-structure></a></h2><p><img src=/imgs/img-lazy-loading.gif data-src=https://imgur.com/qbAYLHV.png alt> [1]</p><p>上圖為 JVM 執行一個 Java 程式的過程：</p><h3 id=class-loader>Class Loader
<a class=header-anchor href=#class-loader></a></h3><p>用於將編譯好的 <code>.class</code> 文件 － <strong>Java Bytecode</strong> 加載到 Runtime Data Areas。</p><h3 id=execution-engine>Execution Engine
<a class=header-anchor href=#execution-engine></a></h3><p>用於執行 Java Bytecode 或是
<a href=https://baike.baidu.com/item/Native%20methods title="native method" rel="noopener external nofollow noreferrer" target=_blank class=exturl>native method
<i class="fa fa-external-link-alt"></i>
</a>.</p><p>Java Bytecode 是以人類仍然可以理解的語言而不是機器語言編寫的。因此，Execution Engine 透過以下兩種方式將字節碼轉為 JVM 中的機器語言。</p><ol><li>Interpreter</li><li>JIT (Just-In-Time) Compiler</li></ol><table><tr><td bgcolor=#fafafa><b>什麼時候用 Interpreter 什麼時候用 Compiler?</b><br>The application code is initially interpreted, but the JVM monitors which part of bytecode are frequently executed and translates them to machine code for direct execution on the hardware.
For bytecode which is executed only a few times, interpret it will saves the compilation time and reduces the initial latency;
For frequently executed bytecode, JIT compilation will be used after an initial phase of slow interpretation.
By interpreting the initial code, execution statistics can be collected before compilation, which helps to perform better optimization.[3]</td></tr></table><p><img src=/imgs/img-lazy-loading.gif data-src=https://imgur.com/H8aD6Eh.png alt> [2]</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://imgur.com/iMbW3Un.png alt> [3]</p><h3 id=runtime-data-areas>Runtime Data Areas
<a class=header-anchor href=#runtime-data-areas></a></h3><p>JVM 運行時所需的的記憶體區塊，總共可以分為六區</p><ul><li>PC Register, JVM Stack 以及 Native Method Stack 依賴於<strong>單個</strong>執行緒的啟動/結束來建立與銷毀。</li><li>Heap, Metaspace(Metod Area & Runtime Constant Pool) 是隨著JVM的啟動而存在，為<strong>全部</strong>的執行緒共享。</li></ul><p><img src=/imgs/img-lazy-loading.gif data-src=https://imgur.com/ZumQcTh.png alt> [4]</p><h4 id=pc-register>PC Register
<a class=header-anchor href=#pc-register></a></h4><p>Program Counter Register，紀錄當前執行緒所執行到的 bytecode 中的指令位址。為了執行緒切換後能恢復到正確的執行位置，每條執行緒都需要有一個獨立的 program counter，各執行緒之間獨立儲存。</p><h4 id=jvm-stack>JVM Stack
<a class=header-anchor href=#jvm-stack></a></h4><p>用來放 frame，每個 method 在執行的同時都會建立一個 stack frame，用於儲存局部變數表 (Local Variable Array)、運算元堆疊 (Operand Stack) 和動態連接 (Dynamic Linking) 以及返回值(Return Value)。每個 method 從呼叫直至結束 (return)，都對應著一個 stack frame 在此區塊中入/出 (push/pop) stack 的過程。<br>JVM Statck 的大小可以是固定的，或是動態擴展的。如果 thread 需要一個比固定大小大的Stack，會發生 <strong>StackOverflowError</strong>；如果動態擴展 Stack 時沒有足夠的記憶體空間，則會發生 <strong>OutOfMemoryError</strong>。</p><pre><code>![](https://imgur.com/WDOImGT.png)

![](https://imgur.com/GT53vZO.png)
[5]
</code></pre><h5 id=局部變量表-local-variable-array>局部變量表 (Local Variable Array)
<a class=header-anchor href=#%e5%b1%80%e9%83%a8%e8%ae%8a%e9%87%8f%e8%a1%a8-local-variable-array></a></h5><p>局部變量表用於存放方法參數和方法內部定義的局部變量，其大小在編譯期(.class 前)就被確定。<br>Java 代碼 <code>int a=0; int b=1; int c=2;</code> 對應的局部變量表如下：</p><table><thead><tr><th>Start</th><th>Length</th><th>Slot</th><th>Name</th><th>Signature</th></tr></thead><tbody><tr><td>2</td><td>12</td><td>0</td><td>a</td><td>I</td></tr><tr><td>4</td><td>10</td><td>1</td><td>b</td><td>I</td></tr><tr><td>6</td><td>8</td><td>2</td><td>c</td><td>I</td></tr></tbody></table><ul><li>Start: 變量偏移量。</li><li>Length: 作用域範圍長度。 <code>Start,Start+Length</code> 就是該變量的作用域。</li><li>Slot: 變量槽，一個 Slot (一行) 能存儲 32bit 的 primitive type、reference type、returnAddress 數據，long/dobule 則需要兩個 Slot。</li></ul><h5 id=運算元棧-operand-stack>運算元棧 (Operand Stack)
<a class=header-anchor href=#%e9%81%8b%e7%ae%97%e5%85%83%e6%a3%a7-operand-stack></a></h5><p>用 push,pop 操作數據。operand stack 只是一個臨時的計算過程，要用到 Local variable table 裡面的值，然後得出結果，放入到 local variables 區。</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#75715e>// Java 代碼
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#75715e></span><span style=color:#66d9ef>int</span> a<span style=color:#f92672>=</span><span style=color:#ae81ff>1</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span><span style=color:#66d9ef>int</span> b<span style=color:#f92672>=</span><span style=color:#ae81ff>2</span><span style=color:#f92672>;</span>
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span><span style=color:#66d9ef>int</span> c<span style=color:#f92672>=</span>a<span style=color:#f92672>+</span>b<span style=color:#f92672>;</span>
</span></span></code></pre></div></br><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-fallback data-lang=fallback><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span>// 運算元棧
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span>0: iconst_1 // push 1到操作棧。大於5的int值會用到 bipush &lt;i&gt; 指令。
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">3</span><span>1: istore_0 // pop 頂元素，存儲到index=0的本地變量。
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">4</span><span>2: iconst_2 // push 2 到操作棧
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">5</span><span>3: istore_1 // pop棧頂元素，存儲到index=1的本地變量。
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">6</span><span>4: iload_0 // 把index=0的本地變量加載到棧頂
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">7</span><span>5: iload_1 // 把index=1的本地變量加載到棧頂
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">8</span><span>6: iadd // 把棧頂兩個數pop出來相加，並把結果存放到棧頂
</span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">9</span><span>7: istore_2 // 結果存儲到index=2的本地變量
</span></span></code></pre></div><h5 id=動態連接-dynamic-linking>動態連接 (Dynamic Linking)
<a class=header-anchor href=#%e5%8b%95%e6%85%8b%e9%80%a3%e6%8e%a5-dynamic-linking></a></h5><p>指符號引用（Symbolic References）轉換成為直接引用（Direct References）的過程。每個 Frame 內部都包含一個指向 runtime constant pool 的引用來支援當前方法的程式碼。</p><ul><li>符號引用：以一組符號來描述所引用的目標，符號可以是任何形式的字面量，只要使用時能無歧義地定位到目標即可。方法名，類名，字段名都是符號引用。</li></ul><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:2;-o-tab-size:2;tab-size:2><code class=language-java data-lang=java><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">1</span><span><span style=color:#66d9ef>int</span> i <span style=color:#f92672>=</span> <span style=color:#ae81ff>1</span><span style=color:#f92672>;</span> <span style=color:#75715e>//把整數 1 賦值給 int 型變量 i，整數 1 就是字面量，
</span></span></span><span style=display:flex><span style="white-space:pre;-webkit-user-select:none;user-select:none;margin-right:.4em;padding:0 .4em;color:#7f7f7f">2</span><span><span style=color:#75715e></span>String s <span style=color:#f92672>=</span> <span style=color:#e6db74>&#34;abc&#34;</span><span style=color:#f92672>;</span> <span style=color:#75715e>//abc 是字面量。
</span></span></span></code></pre></div><ul><li>直接引用：可以是直接指向目標的指針、相對偏移量或是一個能間接定位到目標的句柄。如果有了直接引用，那么引用的目標一定是已經存在於內存中。</li></ul><h4 id=native-method-stack>Native Method Stack
<a class=header-anchor href=#native-method-stack></a></h4><p>此區塊主要執行native method。</p><h4 id=heap>Heap
<a class=header-anchor href=#heap></a></h4><p>用於儲存物件的實例(object instance)和陣列，也是 GC 管理的主要區域，因此也被稱為 GC 堆 — Garbage Collected Heap。Heap 是在 JVM 啟動時建立的，為所有執行緒共有。堆的大小可以固定，也可以擴大縮小且不需要是連續空間。</p><h5 id=堆記憶體分配>堆記憶體分配
<a class=header-anchor href=#%e5%a0%86%e8%a8%98%e6%86%b6%e9%ab%94%e5%88%86%e9%85%8d></a></h5><p>現在的 GC 都採 generation-collect 分代收集算法，所以 Heap 記憶體可劃分為：
<img src=/imgs/img-lazy-loading.gif data-src=https://imgur.com/AsMKt4b.png alt> [6]</p><ul><li>Young Generation（年輕代）</li><li>Old Generation（老年代）
其中Young generation可以進一步分為3個區塊: Eden space， Survivor 1 和 Survivor 2</li></ul><h5 id=garbage-collection>Garbage Collection
<a class=header-anchor href=#garbage-collection></a></h5><p>垃圾回收(garbage collection)是指將佔記憶體空間(heap)的不再被參考的物件
清除的過程。</p><p>年輕代回收：又稱小型回收 (minor collection)，執行時機是當年輕代的空間滿的時候會觸發。當新物件產生時會放置在 Eden space，當 Eden space 滿了，JVM 會啟動 Minor GC，把存活的物件往 Survivor 1 或 2 移及以原本在 Survivor 1 或 2 的存活物件往另一個 Survivor 空間移。當 JVM 執行多次 Minor GC 後，會把符合條件的存活物件往 Tenured generation 移，這個過程我們稱為Minor GC。</p><p>老年代或永久代回收稱為完整回收(full collection)或主要回收(major collection)。當 old generation 滿了時，JVM 會回收 Tenured generation 的空間，稱為 Major/Full GC。</p><h5 id=heap-大小對-gc-的影響>heap 大小對 GC 的影響
<a class=header-anchor href=#heap-%e5%a4%a7%e5%b0%8f%e5%b0%8d-gc-%e7%9a%84%e5%bd%b1%e9%9f%bf></a></h5><p>空間比較小的時候，打掃動作比較快，但是相對垃圾累積也比較快滿，所以打掃需要比較頻繁。相反地，空間大，需要打掃的頻率比較低，但是一打掃起來就很費時。通常就是在「時間」、「空間」、「頻率」三者之間作取捨而已。
Minor GC 和 Major/Full都是 &ldquo;Stop the World&rdquo; 事件，只是 Minor GC 時間非常短(幾百milli-seconds)，使用者較不容易察覺;而 Full GC 時間相對上長很多，且 heap size 愈大時間愈久；因此應儘量避免或減少 Full GC 發生。</p><p>若Heap space沒空間存放新建立的物作，則JVM會丟出OutOfMemoryError或 java.lang.OutOfMemoryError heap space</p><h4 id=metaspace-java8-以前以後>MetaSpace (Java8 以前以後)
<a class=header-anchor href=#metaspace-java8-%e4%bb%a5%e5%89%8d%e4%bb%a5%e5%be%8c></a></h4><p><strong>Java 7</strong></p><p><img src=/imgs/img-lazy-loading.gif data-src=https://imgur.com/oturBUp.png alt></p><p><strong>Java 8</strong></p><p><img src=/imgs/img-lazy-loading.gif data-src=https://imgur.com/AsMKt4b.png alt>[6]</p><p>下面這張能更清楚 java 8 的改變:</p><p><img src=/imgs/img-lazy-loading.gif data-src=https://imgur.com/AoP8OjJ.png alt>[7]</p><p>原先存在 heap 用來存放存放 byte code, JIT information, class metadata 以及 static 的變數, 方法的永久代 PermGen 被移到 native memory 的 metaspace 了。</p><h2 id=reference>Reference
<a class=header-anchor href=#reference></a></h2><p>[1]http://mauryasunil007.blogspot.com/2016/04/understanding-jvm-internal-architecture.html<br>[2]https://www.datawareventures.com/single-post/2015/10/09/Field-Specialization-Just-another-JIT<br>[3]https://stackoverflow.com/questions/1326071/is-java-a-compiled-or-an-interpreted-programming-language<br>[4]https://blog.jamesdbloom.com/JVMInternals.html<br>[5]https://alvinalexander.com/scala/fp-book/recursion-jvm-stacks-stack-frames/<br>[6]https://docs.deistercloud.com/content/Axional%20development%20libraries.20/Axional%20Server.4/Tunning.xml?embedded=true<br>[7]https://stackoverflow.com/questions/39675406/difference-between-metaspace-and-native-memory-in-java</p></div><footer class=post-footer><div class=post-tags><a href=/tags/java>Java</a></div><div class=addthis_inline_share_toolbox style=text-align:center></div><hr><div class=post-nav><div class="post-nav-next post-nav-item"><a href=/post/programming-install-java11-on-win10/install-java10-on-win11/ rel=next title="[Java] Install Java on Win11"><i class="fa fa-chevron-left"></i> [Java] Install Java on Win11</a></div><div class="post-nav-prev post-nav-item"><a href=/post/programming-java-jdk-jre/java-jdk-jre-jvm-intro/ rel=prev title="[Java] What are JDK, JRE, JDM ?">[Java] What are JDK, JRE, JDM ?
<i class="fa fa-chevron-right"></i></a></div></div></footer></article></div></div></main><footer class=footer><div class=footer-inner><div class=copyright>&copy;
<span itemprop=copyrightYear>2019 - 2023</span>
<span class=with-love><i class="fa fa-paw"></i></span>
<span class=author itemprop=copyrightHolder>Ula Hsieh</span></div><div class=powered-by>Power by <a href=https://gohugo.io title=0.112.3 target=_blank>Hugo</a> & <a href=https://github.com/hugo-next/hugo-theme-next title=4.5.2 target=_blank>Hugo NexT.Gemini</a></div></div></footer><script type=text/javascript src=https://cdn.staticfile.org/animejs/3.2.1/anime.min.js defer></script>
<script type=text/javascript src=https://cdn.staticfile.org/viewerjs/1.11.0/viewer.min.js defer></script>
<script class=next-config data-name=main type=application/json>{"algolia":{"cfg":{"apikey":"bfe7770719b1074e97acc36accb13bf0","appid":"D00OUNE9TK","enable":true,"hits":{"perpage":10},"indexname":"next-ulagraphy","limit":1e3},"instantjs":{"file":"dist/instantsearch.production.min.js","name":"instantsearch.js","version":"4.49.0"},"js":{"file":"dist/algoliasearch-lite.umd.js","name":"algoliasearch","version":"4.14.2"}},"bookmark":{"color":"#222","enable":false,"save":"manual"},"copybtn":true,"darkmode":true,"giscus":{"cfg":{"category":"Comments","categoryid":null,"emit":false,"inputposition":"top","mapping":"title","reactions":false,"repo":"username/repo-name","repoid":null,"theme":"preferred_color_scheme"},"js":"https://giscus.app/client.js"},"hostname":"https://ulagraphy.netlify.com","i18n":{"ds_day":" Day Ago","ds_days":" Day ","ds_hour":" Hour Ago","ds_hours":" Hour ","ds_just":"Just","ds_min":" Min Ago","ds_mins":" Min","ds_month":" Month Ago","ds_years":" Year ","empty":"We didn't find any results for the search: ${query}","hits":"${hits} results found","hits_time":"${hits} results found in ${time} ms","placeholder":"Searching..."},"lang":"en","lazyload":false,"motion":{"async":true,"enable":true,"transition":{"collheader":"fadeInLeft","postblock":"fadeIn","postbody":"fadeInDown","postheader":"fadeInDown","sidebar":"fadeInUp"}},"postmeta":{"comments":{"enable":true,"plugin":"waline"},"views":{"enable":false,"plugin":"busuanzi"}},"root":"/","scheme":"Gemini","sidebar":{"display":"post","offset":12,"padding":18,"position":"left","width":240},"vendor":{"plugins":"qiniu","router":"https://cdn.staticfile.org"},"version":"4.5.2","waline":{"cfg":{"emoji":false,"imguploader":false,"placeholder":"请文明发言哟 ヾ(≧▽≦*)o","reaction":true,"reactiontext":["点赞","踩一下","得意","不屑","尴尬","睡觉"],"reactiontitle":"你认为这篇文章怎么样？","requiredmeta":["nick","mail"],"serverurl":null,"sofa":"快来发表你的意见吧 (≧∀≦)ゞ","wordlimit":200},"css":{"alias":"waline","file":"dist/waline.css","name":"@waline/client","version":"2.13.0"},"js":{"alias":"waline","file":"dist/waline.js","name":"@waline/client","version":"2.13.0"}}}</script><script type=text/javascript src=/js/main.min.0324574053d02d3fbf9394acb1826aa1bab033e431839d37bcc63ee8cb9b302d.js defer></script></body></html>